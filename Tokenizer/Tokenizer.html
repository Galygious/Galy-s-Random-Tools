<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Text Tokenizer</title>
  <link rel="stylesheet" href="css/tokenizer.css">
</head>
<body>

  <header>
    <h1>Text Tokenizer</h1>
    <p>Tokenize your text inputs effortlessly using <strong>Galygious</strong>'s tools.</p>
  </header>

  <section class="tokenizer">
    <div class="form-container">
      <textarea id="textInput" rows="5" placeholder="Enter text to tokenize..."></textarea>
      
      <div class="file-options">
        <label for="fileUrl">Or Enter File URL:</label>
        <input id="fileUrl" type="url" placeholder="https://example.com/file.txt" />
        
        <label for="fileUpload">Or Upload a File:</label>
        <input id="fileUpload" type="file" accept=".txt" />
      </div>
      
      <button onclick="tokenizeText()">Tokenize</button>
    </div>

    <div class="results" id="results"></div>
  </section>

  <footer>
    <p>Â© <span id="year"></span> Galygious - All Rights Reserved</p>
  </footer>

  <!-- Include Tiktoken Library -->
  <script src="tiktoken.js"></script>
  <script>
    // Automatically fill the current year
    document.getElementById('year').textContent = new Date().getFullYear();

    let encoder = null;

    // Initialize Tiktoken
    async function initializeTokenizer() {
      try {
        encoder = await Tiktoken.init({
          wasmPath: 'tiktoken_bg.wasm',
          encodingPath: 'cl100k_base.json'
        });
        console.log('Tiktoken initialized successfully.');
      } catch (error) {
        console.error('Error initializing Tiktoken:', error);
        document.getElementById('results').innerHTML = `<p style="color:red;">Error initializing tokenizer.</p>`;
      }
    }

    // Call initialize on page load
    window.onload = initializeTokenizer;

    async function tokenizeText() {
      const textInput = document.getElementById("textInput").value.trim();
      const fileUrl = document.getElementById("fileUrl").value.trim();
      const fileUpload = document.getElementById("fileUpload").files[0];
      const resultsDiv = document.getElementById("results");

      let text = textInput;

      // If a file URL is provided, fetch the text from the URL
      if (fileUrl) {
        try {
          const response = await fetch(fileUrl);
          if (!response.ok) throw new Error("Failed to fetch the file.");
          text = await response.text();
        } catch (error) {
          resultsDiv.innerHTML = `<p style="color:red;">Error fetching file: ${error.message}</p>`;
          return;
        }
      }

      // If a file is uploaded, read its content
      if (fileUpload) {
        try {
          const reader = new FileReader();
          reader.onload = function(event) {
            text = event.target.result;
            performTokenization(text);
          };
          reader.readAsText(fileUpload);
          return; // Wait for FileReader to finish
        } catch (error) {
          resultsDiv.innerHTML = `<p style="color:red;">Error reading file: ${error.message}</p>`;
          return;
        }
      }

      performTokenization(text);
    }

    async function performTokenization(text) {
      const resultsDiv = document.getElementById("results");
      
      if (!encoder) {
        resultsDiv.innerHTML = `<p style="color:red;">Tokenizer not initialized yet. Please try again shortly.</p>`;
        return;
      }

      if (!text) {
        resultsDiv.innerHTML = `<p style="color:red;">Please enter text or provide a file.</p>`;
        return;
      }

      resultsDiv.innerHTML = "<p>Tokenizing...</p>";

      try {
        const tokens = encoder.encode(text);
        resultsDiv.innerHTML = `
          <h2>Tokenized Output:</h2>
          <pre>${JSON.stringify(tokens, null, 2)}</pre>
          <button onclick="copyTokens()">Copy Tokens</button>
        `;
        window.tokenizedOutput = tokens;
      } catch (error) {
        resultsDiv.innerHTML = `<p style="color:red;">Error tokenizing text: ${error.message}</p>`;
      }
    }

    function copyTokens() {
      if (!window.tokenizedOutput) return;
      const tokensStr = JSON.stringify(window.tokenizedOutput, null, 2);
      navigator.clipboard.writeText(tokensStr)
        .then(() => {
          alert("Tokens copied to clipboard!");
        })
        .catch(err => {
          alert("Failed to copy tokens: " + err);
        });
    }
  </script>

</body>
</html>
